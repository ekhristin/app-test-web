name: Build and Deploy Pipeline

on:
  push:
    branches: [ "main" ]
    paths:
      - 'Dockerfile'
      - 'index.html'
      - 'nginx.conf'

jobs:
  build:
    name: üèóÔ∏è Build Application
    runs-on: ubuntu-latest
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-built: ${{ steps.build.result }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        id: build
        run: |
          docker build -t app:${{ github.sha }} .
          echo "‚úÖ Build completed"

      - name: Test image
        run: |
          docker run --rm app:${{ github.sha }} nginx -t
          echo "‚úÖ Image tests passed"

      - name: Set metadata
        id: meta
        run: |
          echo "tags=app:${{ github.sha }}" >> $GITHUB_OUTPUT

  push-to-registry:
    name: üì¶ Push to Registry
    runs-on: ubuntu-latest
    needs: build  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç build
    if: needs.build.result == 'success'
    
    steps:
      - name: Push image
        run: |
          echo "Pushing image: ${{ needs.build.outputs.image-tag }}"
          # –õ–æ–≥–∏–∫–∞ push –≤ registry

  deploy:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: push-to-registry  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç push
    if: needs.push-to-registry.result == 'success'
    
    steps:
      - name: Deploy application
        run: |
          echo "Deploying to Kubernetes..."
          # –õ–æ–≥–∏–∫–∞ –¥–µ–ø–ª–æ—è